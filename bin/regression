#!/bin/sh

# This script runs the regression tests in src/regression.

name=`basename $0`

function usage() {
	echo >&2 "usage: $name"
	exit 1
}

case "$#" in
0)
	;;
*)
	usage
	;;
esac

dir=`dirname $0`
root=`cd $dir/../.. && pwd`
src="$root/src"
lib="$root/lib"
bin="$root/bin"
mlton="$bin/mlton"
thread='thread0.sml thread1.sml thread2.sml mutex.sml prodcons.sml'
world='world1.sml world2.sml world3.sml world4.sml world5.sml'
tmp=/tmp/z.regression.$$
log=$src/regression/log

(
	cd $src/regression
	for f in `ls *.sml`
	do
		f=`basename $f .sml`
		case "$f" in
		cobol|serialize|testdyn2)
			echo "skipping $f"
		;;
		*)
 			echo "testing $f"
			$mlton $f.sml
			if [ $? -eq 0 ]; then
				$f >$tmp 2>&1
				if [ -r $f.ok ]; then
					diff $f.ok $tmp
				fi
			else
				echo "compilation of $f failed"
			fi
			rm -f $f $f.cps $f.c
		;;
		esac
	done 
) 2>&1 | tee $log

rm -f $tmp
