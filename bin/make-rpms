#!/bin/sh -x

# This script makes binary and source RPMs and puts them in the current
# directory.

name=`basename $0`

function usage() {
	echo >&2 "usage: $name [-home]"
	exit 1
}

home='no'
while [ "$#" -gt 0 ]; do
	case "$1" in
	-home)
		home='yes'
		shift
		;;
	*)
		usage
		;;
	esac
done

originalDir=`pwd`
version=`date +%Y%m%d`
release="1"
package="mlton-$version-$release"
root="/tmp/mlton-make-rpms-$version"
src="$root/SOURCES/mlton-$version/src"

echo 'Cleaning up'
rm -rf $root
mkdir $root
cd $root
mkdir -p BUILD RPMS/i386 SOURCES SPECS SRPMS

echo 'Checking out sources'
cd $root/SOURCES
mkdir mlton-$version
cd mlton-$version
mkdir bin lib include
cvs -Q co -d src mlton
cvs -Q release src
find src -type d | grep CVS | xargs rm -rf
find src -type f | grep cvsignore | xargs rm -f

function doInst() {
	sed "s/\(.*\)VERSION\(.*\)/\1$version\2/" <$1 >z
	mv z $1
}
	
function instantiate() {
	echo 'Instantiating version numbers'
	for f in web/index.html user-guide/macros.tex \
	 		ANNOUNCE CHANGES README; do
		doInst $f
	done
}
cd $src/doc
instantiate
doInst ../mlton/control/control.sml
sed "/^Version:/s;.*;Version: $version;" <mlton.spec >z
sed "/^Release:/s;.*;Release: $release;" <z >$root/SPECS/mlton.spec
rm -f z

manvers=`date '+%B %d, %Y'`
cd $src/man
for f in mlprof.1 mlton.1; do
	sed "s/\(.*\)VERSION\(.*\)/\1$manvers\2/" <$f >z
	mv z $f
done

echo 'Creating source tgz'
cd $root/SOURCES
ss chown -R root.root mlton-$version
tar.write mlton-$version | gzip >mlton-$version.tgz
ss rm -rf mlton-$version

echo 'Building rpms'
(
	export HOME="$root"
	echo "%_topdir $root" >$root/.rpmmacros
	time rpm --quiet -ba --clean $root/SPECS/mlton.spec
)
cp -p $root/RPMS/i386/$package.i386.rpm $root/SRPMS/$package.src.rpm $originalDir

if [ $home = 'yes' ]; then
	echo 'Building web home'
	echo '  Checking out docs'
	cd $root
	cvs -Q co -d doc mlton/doc
	cvs -Q release doc
	cd $root/doc
	instantiate
	cd web
	make
	cp $originalDir/$package.i386.rpm $originalDir/$package.src.rpm .
	find . -type d | grep CVS | xargs rm -rf
	find . -type f | grep cvsignore | xargs rm -f
	echo '  Building tgz'
	tar.write -x Makefile -x .cvsignore . | gzip >$root/mlton-home.tgz
	echo '  ftp'\''ing'
	remote='hirame'
	cd $root
	(cat | ftp $remote)<<-EOF
		cd www-home
		put mlton-home.tgz
	EOF
fi

echo 'Success'
