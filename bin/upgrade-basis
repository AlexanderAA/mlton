#!/usr/bin/env sh

set -e

die () {
	echo >&2 "$1"
	exit 1
}

name=`basename $0`

usage () {
	die "usage: $name /path/to/mlton"
}

case "$#" in
1)
	mlton="$1"
;;
*)
	usage
;;
esac

tmp="$$.sml"

hasFeature () {
	feature="$1"
	echo "$feature" >$tmp
	$mlton $tmp >/dev/null 2>&1
}

if ! hasFeature 'fun f x : string option = TextIO.inputLine x'; then
	cat<<-EOF
structure TextIO =
   struct
      open TextIO

      fun inputLine ins =
         case TextIO.inputLine ins of
            "" => NONE
          | s => SOME s
   end
EOF
fi
	
if ! hasFeature 'fun f x : string option = OS.FileSys.readDir x'; then
	cat <<-EOF
structure OS =
   struct
      open OS
      structure FileSys =
         struct
            open FileSys
            fun readDir d =
               case FileSys.readDir d of
                  "" => NONE
                | s => SOME s
         end
   end
EOF
fi
rm -f $tmp
rm -f `basename $tmp .sml`
