# Copyright (C) 2004 Henry Cejtin, Matthew Fluet, Suresh
#    Jagannathan, and Stephen Weeks.
#
# MLton is released under the GNU General Public License (GPL).
# Please see the file MLton-LICENSE for license information.
#

TARGET = self
TARGET_ARCH = $(shell ../bin/host-arch)
TARGET_OS = $(shell ../bin/host-os)
GCC_VERSION = $(shell gcc -v 2>&1 | grep 'gcc version' | sed 's/.*gcc version \(.\).*/\1/')

FLAGS = -fomit-frame-pointer

ifeq ($(TARGET_ARCH), x86)
FLAGS += -mcpu=pentiumpro 
ifeq ($(GCC_VERSION), 3)
FLAGS += -falign-loops=2 -falign-jumps=2 -falign-functions=5
else
FLAGS += -malign-loops=2 -malign-jumps=2 -malign-functions=5
endif
endif
ifeq ($(TARGET_ARCH), sparc)
FLAGS += -Wa,-xarch=v8plusa -fcall-used-g5 -fcall-used-g7 -funroll-all-loops -m32 -mv8 -mcpu=ultrasparc
endif

ifeq ($(TARGET), self)
AR = ar rc
else
AR = $(TARGET)-ar rc
FLAGS += -b $(TARGET)
endif

CC = gcc -Wall -I. -Iplatform -D_FILE_OFFSET_BITS=64 $(FLAGS)
CFLAGS = -O2
DEBUGFLAGS = -gstabs+ -g2

CFILES = 							\
	$(shell find basis -type f | grep '\.c$$')		\
	$(shell find Posix -type f | grep '\.c$$')		\
	gc.c							\
	platform.c

FILES = $(basename $(CFILES))

EXTRA_FILES =			\
	platform/$(TARGET_OS)

ifeq ($(COMPILE_FAST), yes)
  OBJS = runtime.o
  DEBUG_OBJS = runtime-gdb.o
else
  OBJS = $(foreach f, $(FILES), $(f).o)
  DEBUG_OBJS = $(foreach f, $(FILES), $(f)-gdb.o)
endif

OBJS += $(foreach f, $(EXTRA_FILES), $(f).o)
DEBUG_OBJS += $(foreach f, $(EXTRA_FILES), $(f)-gdb.o)

all:  libgdtoa.a libmlton.a libmlton-gdb.a

libgdtoa.a: gdtoa/arith.h
	cd gdtoa && $(CC) $(CFLAGS) -w -O1 -c -DINFNAN_CHECK *.c
	$(AR) libgdtoa.a gdtoa/*.o

gdtoa/arithchk.c:
	zcat gdtoa.tgz | tar xf -	
	patch -p0 <gdtoa-patch

gdtoa/arithchk.out: gdtoa/arithchk.c
	cd gdtoa && $(CC) -o arithchk.out arithchk.c

gdtoa/arith.h: gdtoa/arithchk.out
	cd gdtoa && ./arithchk.out >arith.h

libmlton.a: $(OBJS) 
	$(AR) libmlton.a $(OBJS)

libmlton-gdb.a: $(DEBUG_OBJS)
	$(AR) libmlton-gdb.a $(DEBUG_OBJS)

runtime.c: $(CFILES)
	cat $(CFILES) >runtime.c

# gcc 3.2 is buggy (or maybe we're not following the C spec)
# when compiling Real/*.c with -O2.
basis/Real/%.o: basis/Real/%.c
	$(CC) $(CFLAGS) -O1 -c -o $@ $<

%-gdb.o: %.c
	$(CC) $(DEBUGFLAGS) -DASSERT=1 -c -o $@ $<

%.o: %.c
	$(CC) $(CFLAGS) -c -o $@ $<

%-gdb.o: %.S
	$(CC) $(DEBUGFLAGS) -c -o $@ $<

%.o: %.S
	$(CC) $(CFLAGS) -c -o $@ $<

.PHONY: clean
clean:
	../bin/clean

.PHONY: gdtoa-patch
gdtoa-patch:
	cd gdtoa && make clean && rm -f &~
	mv gdtoa gdtoa-new
	zcat gdtoa.tgz | tar xf -
	diff -P -C 2 -r gdtoa gdtoa-new >gdtoa-patch || exit 0
	rm -rf gdtoa
	mv gdtoa-new gdtoa
