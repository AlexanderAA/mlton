SRC = $(shell cd .. && pwd)
BUILD = $(SRC)/build
BIN = $(BUILD)/bin
LIB = $(BUILD)/lib
MLTON = mlton
TARGET = self
NAME = mlton
AOUT = mlton-compile
PATH = $(BIN):$(shell echo $$PATH)
ifeq (self, $(shell if [ -x $(BIN)/mlton ]; then echo self; fi))
  # We're compiling MLton with itself, so don't use any stubs.
  CM = $(NAME).cm
else
ifeq (cygwin, $(shell $(SRC)/bin/host-os))
  # The stubs don't work on Cygwin, since they define spawn in terms of
  # fork, and fork doesn't work on Cygwin.  So, make without the stubs.
  CM = $(NAME).cm
else
  # We're compiling MLton with an older version of itself, so use the stubs for
  # the MLton structure.
ifeq (1997, $(shell $(SRC)/bin/mlton-basis-version))
  CM = $(NAME)-stubs-1997.cm
else
  CM = $(NAME)-stubs.cm
endif
endif
endif

FLAGS = @MLton $(RUNTIME_ARGS) gc-summary --
ifeq (new,$(shell PATH=$(BIN):$$PATH; $(MLTON) -target self >/dev/null 2>&1 && echo new))
  FLAGS += -target $(TARGET)
else
  FLAGS += -host $(TARGET)
endif
ifeq (new,$(shell PATH=$(BIN):$$PATH; $(MLTON) -verbose 1 >/dev/null 2>&1 && echo new))
  FLAGS += -verbose 1 -output $(AOUT)
else
  FLAGS += -v -o $(AOUT)
endif

.PHONY: all
all: $(AOUT)

$(AOUT): $(NAME).cm $(shell $(MLTON) -stop f $(NAME).cm)
	@echo 'Compiling mlton (takes a while)'
	$(MLTON) $(FLAGS) $(CM)
	size $(AOUT)

.PHONY:	$(NAME)_cm
$(NAME)_cm: $(NAME)-stubs_cm
	grep -v mlton-stubs $(NAME)-stubs.cm >$(NAME).cm

.PHONY: $(NAME)-stubs-1997_cm
$(NAME)-stubs-1997_cm: $(NAME)-stubs_cm
	(								\
		echo 'Group is' &&					\
		echo '../lib/mlton-stubs/1997-to-2002.sml' &&		\
		grep -v Group $(NAME)-stubs.cm;				\
	) >$(NAME)-stubs-1997.cm

# This makes a version of MLton that can be compiled in the standard basis
# library.  I.E. it doesn't require a MLton structure.
.PHONY:	$(NAME)-stubs_cm
$(NAME)-stubs_cm: front-end/ml.lex.sml front-end/ml.grm.sig front-end/ml.grm.sml
	(								\
		echo 'Group is' &&					\
		cmcat sources.cm | grep -v 'basis-stubs' | 		\
			grep -v 'mlton-stubs-in-smlnj' |		\
			grep mlyacc &&					\
		cmcat sources.cm | grep -v 'basis-stubs' | 		\
			grep -v 'mlton-stubs-in-smlnj' |		\
			grep -v mlyacc &&				\
		echo 'call-main.sml';					\
	) >$(NAME)-stubs.cm

.PHONY: nj-whole
nj-whole: front-end/ml.lex.sml front-end/ml.grm.sig front-end/ml.grm.sml
	(									\
		echo 'SMLofNJ.Internals.GC.messages false;';			\
		echo '#set CM.Control.verbose false;';				\
		echo '#set CM.Control.warn_obsolete false;';			\
		echo 'Control.polyEqWarn := false;'; 				\
		echo 'local'; 							\
		cmcat sources.cm | grep 'mlton-stubs-in-smlnj' | xargs cat;	\
		cmcat sources.cm | grep 'mlyacc' | xargs cat;			\
		cmcat sources.cm | grep -v 'mlyacc' |				\
			grep -v 'mlton-stubs-in-smlnj' | xargs cat; 		\
		echo 'in';							\
		echo 'val _ = Main.exportNJ ("$(SRC)/basis-library", "$(LIB)/mlton")';	\
		echo 'end';							\
	) >$(NAME).whole.sml
	$(SML) <$(NAME).whole.sml

mlton.sml: $(NAME).cm $(shell $(MLTON) -stop f mlton.cm)
	rm -f mlton.sml && mlton -stop sml mlton.cm && chmod -w mlton.sml

front-end/ml.lex.sml: front-end/ml.lex
	rm -f front-end/ml.lex.sml
	mllex front-end/ml.lex
	chmod -w front-end/ml.lex.sml

front-end/ml.grm.sig front-end/ml.grm.sml: front-end/ml.grm
	rm -f front-end/ml.grm.*
	mlyacc front-end/ml.grm
	chmod -w front-end/ml.grm.*

.PHONY: clean
clean:
	../bin/clean

#
# The following rebuilds the heap file for the SML/NJ compiled version
# of MLton.
# It requires that you have SML/NJ with the Compilation
# Manager (CM) installed.  You may need to replace the following with
# 'sml-cm'.
#
SML	= sml

.PHONY: nj-mlton
nj-mlton: front-end/ml.lex.sml front-end/ml.grm.sig front-end/ml.grm.sml
	(									\
		echo 'SMLofNJ.Internals.GC.messages false;';			\
		echo '#set CM.Control.verbose false;';				\
		echo '#set CM.Control.warn_obsolete false;';			\
		echo 'Control.polyEqWarn := false;';				\
		echo 'CM.make "sources.cm";';					\
		echo 'Main.exportNJ ("$(SRC)/basis-library", "$(LIB)/mlton");'	\
	) | $(SML)

.PHONY: nj-mlton-dual
nj-mlton-dual: front-end/ml.lex.sml front-end/ml.grm.sig front-end/ml.grm.sml
	(									\
		echo 'SMLofNJ.Internals.GC.messages false;';			\
		echo '#set CM.Control.verbose false;';				\
		echo '#set CM.Control.warn_obsolete false;';			\
		echo 'Control.polyEqWarn := false;';				\
		echo 'val _ = CM.Server.start {cmd = (CommandLine.name (), ["@CMslave"]), name = "server1", pathtrans = NONE, pref = 0};';\
		echo 'val _ = CM.Server.start {cmd = (CommandLine.name (), ["@CMslave"]), name = "server2", pathtrans = NONE, pref = 0};';\
		echo 'CM.make "sources.cm";';					\
		echo 'Main.exportNJ ("$(SRC)/basis-library", "$(LIB)/mlton");'	\
	) | $(SML)

.PHONY: nj-mlton-110.9.1
nj-mlton-110.9.1: front-end/ml.lex.sml front-end/ml.grm.sig front-end/ml.grm.sml
	(									\
		echo 'SMLofNJ.Internals.GC.messages false;';			\
		echo 'CM.verbose (SOME false);';				\
		echo 'CM.make'\''{group = "sources.cm", force_relink = true};';	\
		echo 'Main.exportNJ ("$(SRC)/basis-library", "$(LIB)/mlton");'	\
	) | $(SML)
